---
title: "Microscopy Data"
author: "Juan P Barraza"
date: "6/19/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(pixmap)
library(rtiff)
library(reshape2)
library(gplots)
library(dplyr)
library(gdata)
library(ggplot2)
library(cowplot)
library(magrittr)
library(tidyr)
library(purrr)
#library(moderndive)
PA14wt<- c('3-13-19', '3-19-19', '4-17-19')
PA14mut<- c('4-24-19', '4-25-19', '5-8-19')
PA01wt<- c('3-26-19','4-18-19')
PA01mut<- c('4-23-19')
names3<-c('rep1','rep2','rep3')
names2<-c('rep1','rep2')
names1<-c('rep1')
figuresPath<-"/Users/jupabago/Documents/Whiteley/PROJECTS/PaSaProject/Figures"#this is to save the figures as I am making them
GetNumber<-function(idx){
  if (idx<10){
    idx = paste0(0,idx)
  }
  return (idx)
}
```

#Analysis of thresholds
```{r thresholds functions}
MapThreshold<- function(listSamples, reps){
  mappedData<-map2(listSamples, reps, GetThresholds)
  boundData<-bind_rows(mappedData)
  blah <-deparse(substitute(listSamples))#this is to obtain the name of the list as a string
  boundData<-boundData %>% mutate(Strain = blah)#this inserts the name into a column, but it wont work in just one line =(
  boundData<- gather(boundData, "Color", "Value", -Position, -Sample, -TimePoint, -Strain)
  boundData<-boundData %>% mutate(Condition = recode(Position, "0" = "Sa Mono", "1" = "Pa Mono", "2" = "Pa:Sa 1:1", "3" = "Pa:Sa 10:1", "4" = "Pa:Sa 1:100", "5" = "Pa:Sa 1:10") )%>% mutate(Species = recode(Color, "Red" = "Sa", "Green" = "Pa"))
  boundData$Condition<-as.factor(boundData$Condition)
  boundData$Condition<-factor(boundData$Condition, levels = c("Sa Mono", "Pa Mono", "Pa:Sa 1:1", "Pa:Sa 1:10", "Pa:Sa 1:100","Pa:Sa 10:1"))
  boundData$Species<-as.factor(boundData$Species)
  boundData$Strain<-as.factor(boundData$Strain)
  return(boundData)
}
 
GetThresholds<-function(sample, samplename){
  folder<- paste0('/Users/jupabago/Documents/Whiteley/PROJECTS/PaSaProject/Spatial paper Data/Microscopy Data/Other Data/',sample,'/threshold')
  fileList<-list.files(path = folder, full.names = TRUE)
  growthDf<-data.frame()
  for (position in 0:5){
    currentPosition<-fileList[grep(paste0("p_",position,"."),fileList)]
    growthDf<-rbind(growthDf,ReadThresholdFile(currentPosition, position))}
  growthDf<-growthDf %>% mutate(Sample = samplename)
return(growthDf)
}
ReadThresholdFile<-function(file, position ){#This function outputs total number of pixels in the csv file from matlab
  datos <-read.csv(file, header = FALSE)
  colnames(datos)<-c('Red', 'Green')
  datos<-datos %>% mutate(Position = position)
  datos$Position<-as.factor(datos$Position)
  datos<-datos %>% mutate(TimePoint = row_number()-1)
  return(datos)
}
```

```{r thresholds data and figures}
wtThresholds<-MapThreshold(PA14wt, names3)
mutThresholds<-MapThreshold(PA14mut, names3)
Pa01Thresholds<-MapThreshold(PA01wt, names2)
Pa01mutThresholds<-MapThreshold(PA01mut, names1)
thresholdData<-rbind(wtThresholds,mutThresholds,Pa01Thresholds,Pa01mutThresholds)
#This is to get an idea of the thresholding levels
#this is for all samples of Pa 
ggplot()+
  geom_jitter(data=thresholdData %>% filter(Species=="Pa"),height = 0, width = .1, aes(x=TimePoint, y=Value, shape = Sample, color = Strain), size=3)+
  facet_grid(.~Condition)
#This is only for PA14 since they seem to be the most consistent
PA14thresholdData <-thresholdData%>%filter(Species=="Pa") %>% filter(Strain %in% c("PA14wt", "PA14mut")) %>% group_by(Position, TimePoint, Strain, Condition, Species)%>% summarise(MeanThreshold = mean(Value), SDThreshold = sd(Value))
PA14average<-PA14thresholdData %>% group_by(Position, Strain, Condition, Species)%>% summarise(MeanThreshold = mean(MeanThreshold), SDThreshold = sd(MeanThreshold))
ggplot()+
  geom_point(data=thresholdData %>% filter(Species=="Pa")%>% filter(Strain %in% c("PA14wt", "PA14mut")), aes(x=TimePoint, y=Value, shape = Sample, color = Strain), size=2)+
  geom_line(data=PA14thresholdData,aes(x = TimePoint, y = MeanThreshold, color =Strain), size = 1)+
  geom_errorbar(data=PA14thresholdData,aes(x = TimePoint, ymin = MeanThreshold-SDThreshold, ymax = MeanThreshold+SDThreshold, color = Strain), width=.5, size = .5)+
  geom_hline(data = PA14average, aes(yintercept = MeanThreshold, color = Strain), size = 3)+
  facet_grid(.~Condition)
#Now we do Staph
SathresholdData <-thresholdData%>%filter(Species=="Sa") %>% group_by(Position, TimePoint, Strain, Condition, Species)%>% summarise(MeanThreshold = mean(Value), SDThreshold = sd(Value))
Saaverage<-SathresholdData %>% group_by(Position, Strain, Condition, Species)%>% summarise(MeanThreshold = mean(MeanThreshold), SDThreshold = sd(MeanThreshold))
ggplot()+
  geom_point(data=thresholdData %>% filter(Species=="Sa"), aes(x=TimePoint, y=Value, shape = Sample, color = Strain), size=2)+
  geom_line(data=SathresholdData,aes(x = TimePoint, y = MeanThreshold, color =Strain), size = 1)+
  geom_errorbar(data=SathresholdData,aes(x = TimePoint, ymin = MeanThreshold-SDThreshold, ymax = MeanThreshold+SDThreshold, color = Strain), width=2, size = .1)+
  geom_hline(data = Saaverage, aes(yintercept = MeanThreshold, color = Strain), size = 3)+
  facet_grid(.~Condition)
#For now, lets focus on the PA14 strains:
ggplot()+
  geom_point(data=thresholdData %>% filter(Species=="Sa") %>%filter(Strain %in% c("PA14wt", "PA14mut")), aes(x=TimePoint, y=Value, shape = Sample, color = Strain), size=2)+
  geom_line(data=SathresholdData%>%filter(Strain %in% c("PA14wt", "PA14mut")),aes(x = TimePoint, y = MeanThreshold, color =Strain), size = 1)+
  geom_errorbar(data=SathresholdData%>%filter(Strain %in% c("PA14wt", "PA14mut")),aes(x = TimePoint, ymin = MeanThreshold-SDThreshold, ymax = MeanThreshold+SDThreshold, color = Strain), width=2, size = .1)+
  geom_hline(data = Saaverage%>%filter(Strain %in% c("PA14wt", "PA14mut")), aes(yintercept = MeanThreshold, color = Strain), size = 3)+
  facet_grid(.~Condition)+
    theme_cowplot(12)
```

```{r threshold weighted growth curves}
#These are the dataframes that we need to merge
#I am not entirely sure what this should tell you, but I thought about multiplying the threshold by the value to see if something comes up
thresholdResultsDf<-merge(cleanResults, thresholdData) %>% mutate(WeightedLogValue = Value*LogTotals) %>% mutate(WeightedValue = Value *Totals) %>% mutate(correctedWeightedLogValue = WeightedLogValue+5) 
thresholdData$Condition<-as.factor(thresholdData$Condition)
 boundData$Condition<-as.factor(boundData$Condition)
  ggplot()+
    geom_point(data=thresholdResultsDf%>% filter(Species == "Pa"), aes(x=TimePoint, y=correctedWeightedLogValue,  shape = Sample), size=2)+
    geom_point(data=cleanResults%>% filter(Species == "Pa"), aes(x=TimePoint, y=LogTotals,  shape = Sample), size=2, color = "red")+
    facet_grid(Strain~Condition)
  
ggplot()+
    geom_point(data=thresholdResultsDf%>% filter(Species == "Sa"), aes(x=TimePoint, y=correctedWeightedLogValue,  shape = Sample), size=2)+
    geom_point(data=cleanResults%>% filter(Species == "Sa"), aes(x=TimePoint, y=LogTotals,  shape = Sample), size=2, color = "red")+
    facet_grid(Strain~Condition)
```

```{r regression models for thresholds}
#Linear regressions

#First get a df with only condition wanted in Red Channel
SaMonoTrhesholdDf<-thresholdData%>% filter(Condition == "Sa Mono") %>% filter(Species == "Sa")
PaSa1.1TrhesholdDf<-thresholdData%>% filter(Condition == "Pa:Sa 1:1") %>% filter(Species == "Sa") %>% filter(Strain %in% c("PA14wt","PA14mut"))

#Linear regression for Thresholds
#Mono
lm(SaMonoTrhesholdDf$Value ~ SaMonoTrhesholdDf$TimePoint) 
plot(SaMonoTrhesholdDf$TimePoint, SaMonoTrhesholdDf$Value)
abline( 0.18154, 0.00819 )
#Linear regression for Weighted Growth Curves
SaMonoWeightedGrowthCurve<-thresholdResultsDf%>% filter(Condition == "Sa Mono") %>% filter(Species == "Sa")
lmWeighted<-lm(SaMonoWeightedGrowthCurve$WeightedLogValue ~ SaMonoWeightedGrowthCurve$TimePoint) 
plot(SaMonoWeightedGrowthCurve$TimePoint, SaMonoWeightedGrowthCurve$WeightedLogValue)
abline( 1.01962, 0.06641 )
#Non-linear model
ggplot()+
  geom_smooth(data=SaMonoTrhesholdDf, aes(x=TimePoint, y=Value), size=2)+
  geom_point(data=SaMonoTrhesholdDf, aes(x=TimePoint, y=Value), size=2)
ggplot()+
  geom_smooth(data=SaMonoTrhesholdDf, method = lm, aes(x=TimePoint, y=Value), size=2)+
  geom_point(data=SaMonoTrhesholdDf, aes(x=TimePoint, y=Value), size=2)

#Co 1:1
lm(PaSa1.1TrhesholdDf$Value ~ PaSa1.1TrhesholdDf$TimePoint) 
plot(PaSa1.1TrhesholdDf$TimePoint, PaSa1.1TrhesholdDf$Value)
abline( 0.1909, -0.00386 )

#Now do the same for Pa
Pa14wtMonoTrhesholdDf<-thresholdData%>% filter(Condition == "Pa Mono") %>% filter(Species == "Pa") %>% filter(Strain == "PA14wt")
Pa14mutMonoTrhesholdDf<-thresholdData%>% filter(Condition == "Pa Mono") %>% filter(Species == "Pa") %>% filter(Strain == "PA14mut")
#Linear regression for Thresholds PA14wt
lm(Pa14wtMonoTrhesholdDf$Value ~ Pa14wtMonoTrhesholdDf$TimePoint) 
plot(Pa14wtMonoTrhesholdDf$TimePoint, Pa14wtMonoTrhesholdDf$Value)
abline( 0.08775, -0.001566 )
lm(Pa14mutMonoTrhesholdDf$Value ~ Pa14mutMonoTrhesholdDf$TimePoint) 
plot(Pa14mutMonoTrhesholdDf$TimePoint, Pa14mutMonoTrhesholdDf$Value)
abline( 0.082315, -0.001234 )
#Non-linear model

#PA14wt
ggplot()+
  geom_smooth(data=Pa14wtMonoTrhesholdDf, method = lm, aes(x=TimePoint, y=Value), size=2)+
  geom_point(data=Pa14wtMonoTrhesholdDf, aes(x=TimePoint, y=Value), size=2)
ggplot()+
  geom_smooth(data=Pa14wtMonoTrhesholdDf, aes(x=TimePoint, y=Value), size=2)+
  geom_point(data=Pa14wtMonoTrhesholdDf, aes(x=TimePoint, y=Value), size=2)
#PA14mut
ggplot()+
  geom_smooth(data=Pa14mutMonoTrhesholdDf, method = lm, aes(x=TimePoint, y=Value), size=2)+
  geom_point(data=Pa14mutMonoTrhesholdDf, aes(x=TimePoint, y=Value), size=2)
ggplot()+
  geom_smooth(data=Pa14mutMonoTrhesholdDf, aes(x=TimePoint, y=Value), size=2)+
  geom_point(data=Pa14mutMonoTrhesholdDf, aes(x=TimePoint, y=Value), size=2)
```
#Biomass with threshold by time points
```{r biomass functions to read data}
MapResults<- function(listSamples, reps){
  blah <-deparse(substitute(listSamples))
  mappedData<-map2(listSamples, reps, GetResults)
  boundData<-bind_rows(mappedData)
  boundData<-boundData %>% mutate(Strain = blah)
  boundData<-gather(boundData,"Color","Value",-Slice,-Position,-Sample,-TimePoint,-Strain) %>% mutate(LogValue=ifelse(Value>0,log10(Value),0))
  boundData<-boundData %>% mutate(Condition = recode(Position, "0" = "Sa Mono", "1" = "Pa Mono", "2" = "Pa:Sa 1:1", "3" = "Pa:Sa 10:1", "4" = "Pa:Sa 1:100", "5" = "Pa:Sa 1:10" )) %>% mutate(Species = recode(Color, "Red" = "Sa", "Green" = "Pa")) %>% mutate(ZDistance = Slice *0.44)
  boundData$Condition<-as.factor(boundData$Condition)
  boundData$Condition<-factor(boundData$Condition, levels = c("Sa Mono", "Pa Mono", "Pa:Sa 1:1", "Pa:Sa 1:10", "Pa:Sa 1:100","Pa:Sa 10:1"))
  boundData$Species<-as.factor(boundData$Species)
  boundData$Strain<-as.factor(boundData$Strain)
  return(boundData)
  }
GetResults<-function(sample, samplename){
  folder<- paste0('/Users/jupabago/Documents/Whiteley/PROJECTS/PaSaProject/Spatial paper Data/Microscopy Data/Other Data/',sample,'/results')
  fileList<-list.files(path = folder, full.names = TRUE)
  growthDf<-data.frame()
  for (position in 0:5){
    currentPosition<-fileList[grep(paste0("p",position,"."),fileList)]
    for (timepoint in 0:17){
      currentTimePoint<-currentPosition[grep(paste0("t",GetNumber(timepoint),"_"),currentPosition)]
      growthDf<-rbind(growthDf,ReadResultsFile(currentTimePoint, position, timepoint))}}
  growthDf<-growthDf %>% mutate(Sample = samplename)
return(growthDf)
}
ReadResultsFile<-function(file, position, timepoint){
  datos <-read.csv(file, header = FALSE)
  colnames(datos)<-c('Red', 'Green', 'Slice')
  datos<-datos %>% mutate(Position = position)
  datos<-datos %>% mutate(TimePoint = timepoint)
  return(datos)
}
```

```{r biomass data}
#Run the biomass functions on each set of samples and combine them at the end  
wtResults<-MapResults(PA14wt, names3) 
mutResults<-MapResults(PA14mut, names3)
Pa01Results<-MapResults(PA01wt, names2)
Pa01mutResults<-MapResults(PA01mut, names1)
ResultsData<-rbind(wtResults,mutResults,Pa01Results,Pa01mutResults)
#Make it tidy and dostats (Add up all the data on each slice and then gets the log of that total)
cleanResults<-ResultsData %>% group_by(TimePoint,Sample,Strain,Condition,Species) %>% summarise(Totals = sum (Value))%>% mutate(LogTotals = ifelse(Totals>0, log10(Totals), 0))
cleanResultsStats<-cleanResults %>% group_by(TimePoint,Strain,Condition,Species) %>% summarise(MeanTotals = mean(Totals), SDTotals = sd(Totals), MeanLogTotals = mean(LogTotals), SDLogTotals = sd(LogTotals)) %>% mutate(MeanLogTotalsRevd = 10^MeanLogTotals, SDLogTotalsRevd =10^(SDLogTotals)) #stats between reps
#This is just to check the difference between the mean log and the log of the mean, which are quite different as it turns out...
clean1ResultsStats<-cleanResultsStats %>% mutate(CheckLog = MeanLogTotals^10) %>% mutate(CheckLog2 = log10(MeanTotals)) %>% mutate(DiffLog = abs(MeanLogTotals-CheckLog2)) %>% mutate(DiffTotals = abs(MeanTotals - CheckLog))
```

```{r biomass plotting functions}
GraphGrowthCurves<-function (dataRaw, dataStats, bug){
  if(bug=="Sa"){dataRaw<-dataRaw %>% filter(Species == "Sa")%>% filter(!Condition == "Pa Mono");
  dataStats<-dataStats %>% filter(Species == "Sa")%>% filter(!Condition == "Pa Mono");nombre<-"S. aureus"}
  if(bug=="Pa"){dataRaw<-dataRaw %>% filter(Species == "Pa")%>% filter(!Condition == "Sa Mono");
  dataStats<-dataStats %>% filter(Species == "Pa")%>% filter(!Condition == "Sa Mono");nombre<-"P. aeruginosa"}
  ggplot()+
    geom_point(data=dataRaw, aes(x=TimePoint, y=Totals),  color = "Black", size=2)+
    geom_point(data=dataStats, aes(x=TimePoint, y=MeanTotals),  color = "Red", size=2)+
    geom_line(data=dataStats, aes(x=TimePoint, y=MeanTotals),  color = "Red", size=2)+
    scale_y_log10(limits= c(1e4,1e7), name=expression(paste('Biomass from voxel counts' )), breaks = c(10^(seq(5,10,.5))), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
    labs(title =paste(bug, "growth in mono in SCFM2" ),  x = "Time (hours)",shape = "Culture condition", color = "Antiobiotic/Control")+
    facet_grid(Strain~Condition)+
    theme_cowplot(12)
}
GraphGrowthCurvesExp<-function (dataRaw,dataStats, bug){
  if(bug=="Sa"){dataRaw<-dataRaw %>% filter(Species == "Sa")%>% filter(!Condition == "Pa Mono");
  dataStats<-dataStats %>% filter(Species == "Sa")%>% filter(!Condition == "Pa Mono");colore<-"Red"}
  if(bug=="Pa"){dataRaw<-dataRaw %>% filter(Species == "Pa")%>% filter(!Condition == "Sa Mono");
  dataStats<-dataStats %>% filter(Species == "Pa")%>% filter(!Condition == "Sa Mono");colore<-"Green"}
  ggplot()+
    geom_point(data=dataRaw, aes(x=TimePoint, y=LogTotals),  color = "Black", size=2)+
    geom_point(data=dataStats, aes(x=TimePoint, y=MeanLogTotals),  color = colore, size=2)+
    geom_line(data=dataStats, aes(x=TimePoint, y=MeanLogTotals),  color = colore, size=2)+
    labs(title =paste(bug, "growth in SCFM2" ),  x = "Time (hours)",shape = "Culture condition", color = "Antiobiotic/Control")+
    facet_grid(Strain~Condition)+
    theme_cowplot(12)
}
GraphGrowthCurvesExpClean<-function (dataRaw, dataStats, bug){
  if(bug=="Sa"){dataStats<-dataStats %>% filter(Species == "Sa")%>% filter(!Condition == "Pa Mono");colore<-"Red"}
  if(bug=="Pa"){dataStats<-dataStats %>% filter(Species == "Pa")%>% filter(!Condition == "Sa Mono");colore<-"Green"}
  ggplot()+
    #geom_point(data=dataStats, aes(x=TimePoint, y=MeanLogTotals,  color = Condition), size=2)+
    geom_line(data=dataStats, aes(x=TimePoint, y=MeanLogTotals,  color = Condition), size=2)+
    labs(title =paste(bug, "growth in SCFM2" ),  x = "Time (hours)",shape = "Culture condition", color = "Antiobiotic/Control")+
    facet_grid(.~Strain)
}
GraphGrowthCurvesExp(cleanResults,cleanResultsStats, "Sa")
GraphGrowthCurvesExp(cleanResults,cleanResultsStats, "Pa")
GraphGrowthCurvesExpClean(cleanResults,cleanResultsStats, "Sa")
GraphGrowthCurvesExpClean(cleanResults,cleanResultsStats, "Pa")
```
Data from S. aureus. 
Remember that all mono cultures of Sa are essentially the same: Same strain, same inoculum, same condition. So this is the only condition where you have several replicates.
```{r Biomass Sa}
#First Isolate Sa Mono
cleanResultsSa <- cleanResults %>% filter(Species == "Sa")
cleanResultsSaMono<- cleanResultsSa %>% filter(Condition == "Sa Mono")
ggplot()+
  geom_point(data=cleanResultsSa %>% filter(Condition == "Sa Mono"), aes(x=TimePoint, y=Totals),  color = "Black", size=2)+
  geom_smooth(data=cleanResultsSaMono, aes(x=TimePoint, y=Totals), size=3, color = "red")+
  scale_y_log10(limits= c(1e4,1e7), name=expression(paste('Biomass from voxel counts' )), breaks = c(10^(seq(5,10,.5))), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  labs(title =expression(paste(italic("S. aureus"), " growth in mono in SCFM2" )),  x = "Time (hours)",shape = "Culture condition", color = "Antiobiotic/Control") 
ggplot()+
  geom_point(data=cleanResultsSa, aes(x=TimePoint, y=Totals, shape = NULL,  color =Strain), size=3)+
  scale_y_log10(limits= c(1e4,1e7), name=expression(paste('Biomass' )), breaks = c(10^(seq(5,10,.5))), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  facet_grid(~Condition)+
  labs(title =expression(paste(italic("S. aureus"), " growth in mono or coculture in SCFM2" )),  x = "Time (hours)",shape = "Culture condition", color = "Antiobiotic/Control") 
#Now Sa Co-culture
cleanResultsSaCo<- cleanResultsSa %>% filter(!Condition == "Sa Mono")
ggplot()+
  geom_point(data=cleanResultsSaCo, aes(x=TimePoint, y=Totals,  color = Strain), size=2)+
  geom_smooth(data=cleanResultsSaCo, aes(x=TimePoint, y=Totals, color = Strain), size=3)+
  scale_y_log10(limits= c(1e4,1e7), name=expression(paste('Biomass from voxel counts' )), breaks = c(10^(seq(5,10,.5))), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  labs(title =expression(paste(italic("S. aureus"), " growth in mono in SCFM2" )),  x = "Time (hours)",shape = "Culture condition", color = "Antiobiotic/Control")+
  facet_grid(~Condition)
```

```{r growth rates Sa}
#first try to fit it to a model fro exponential growth: 
exponential.model <- lm(log(cleanResultsSaMono$Totals)~ cleanResultsSaMono$TimePoint)
summary(exponential.model)
#not very good... So I found the package "growthrates", so I'll try that
#https://cran.r-project.org/web/packages/growthrates/vignettes/Introduction.html
splitted.data <- multisplit(cleanResultsSaMono, c("Strain", "Sample"))
dat<-splitted.data[[1]]
fit <- fit_easylinear(dat$TimePoint, dat$Totals)
summary(fit)#summary of values
coef(fit) #exponential growth parameters
rsquared(fit)  # coefficient of determination (of log-transformed data)
deviance(fit)  # residual sum of squares of log-transformed data
par(mfrow = c(1, 2)) 
plot(fit, log = "y")
plot(fit) 
many_fits <- all_easylinear(Totals ~ TimePoint | Strain + Sample, data = cleanResultsSaMono, h = 4)#the h is the number of points considered for fit
par(mfrow = c(3, 3))#establish the grid
plot(many_fits,log = "y")#plot many things
testdf<-data.frame(as.list(rsquared))#convert to data frame
#this is the mean rsquared for the growth curves. Not super useful, but it is the syntax for more interesting stuff
pa14GrowthRates<- testdf %>% select(contains("PA14")) %>% gather() %>% summarise(mean = mean(value))
#Now with all the conditions and find different growth rates
```

Data from P. aeruginosa

This is a completely different story since I used different Strains of Pa throughout the project. So here they are:
```{r biomass Pa}
cleanResultsPaMono<- cleanResultsPa %>% filter(Condition == "Pa Mono")
ggplot()+
  geom_point(data=cleanResultsPaMono, aes(x=TimePoint, y=Totals, color =Strain), size=2)+
  geom_smooth(data=cleanResultsPaMono, aes(x=TimePoint, y=Totals, color = Strain), size=3)+
  #geom_smooth(data=cleanResultsPaMono, method = "gam",  aes(x=TimePoint, y=Totals, color = Strain), linetype = "dashed", size=3)+
  scale_y_log10(limits= c(1e4,1e7), name=expression(paste('CFUs per mL' )), breaks = c(10^(seq(5,10,.5))), labels = scales::trans_format("log10", scales::math_format(10^.x)))
  #facet_grid(~Strain)
#model to Fit into an exponential 
```

```{r biomass Pa and Sa}
ggplot()+
  geom_point(data=cleanResultsSaMono, aes(x=TimePoint, y=Totals),  color = "Black", size=2)+
  geom_point(data=cleanResultsPaMono, aes(x=TimePoint, y=Totals, color =Strain), size=2)+
  geom_smooth(data=cleanResultsPaMono, aes(x=TimePoint, y=Totals, color = Strain), size=3)+
  geom_smooth(data=cleanResultsSaMono, aes(x=TimePoint, y=Totals), size=3, color = "red")+
  #geom_smooth(data=cleanResultsPaMono, method = "gam",  aes(x=TimePoint, y=Totals, color = Strain), linetype = "dashed", size=3)+
  scale_y_log10(limits= c(1e4,1e7), name=expression(paste('Biomass in voxels' )), breaks = c(10^(seq(5,10,.5))), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  labs(title =expression(paste(italic("S. aureus"), " and ", italic("P. aeruginosa"), "growth in mono in SCFM2" )),  x = "Time (hours)")
ggplot()+
  scale_y_log10(limits= c(1e4,1e7), name=expression(paste('Biomass from voxel counts' )), breaks = c(10^(seq(5,10,.5))), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  labs(title =expression(paste(italic("S. aureus"), " growth in mono in SCFM2" )),  x = "Time (hours)",shape = "Culture condition", color = "Antiobiotic/Control") 
```

```{r aggregates}
MapAggregates<- function(listSamples, reps){
  mappedData<-map2(listSamples, reps, GetAggregates)
  boundData<-bind_rows(mappedData)
  blah <-deparse(substitute(listSamples))
  boundData<-boundData %>% mutate(Strain = blah)#needs to be two lines, it doesnt work if you do it directly
  return(boundData)
  }
GetAggregates<-function(sample, samplename){
  folder<- paste0('/Users/jupabago/Documents/Whiteley/PROJECTS/Spatial paper Data/Microscopy Data/Other Data/',sample,'/aggregateSizes')
  fileList<-list.files(path = folder, full.names = TRUE)
  growthDf<-data.frame()
  for (position in 0:5){
    currentPosition<-fileList[grep(paste0("p_",position,"."),fileList)]
    for (timepoint in 0:17){
      currentTimePoint<-currentPosition[grep(paste0("t_",GetNumber(timepoint),"p_"),currentPosition)]
      growthDf<-rbind(growthDf,ReadAggregateFile(currentTimePoint, position, timepoint))
      }
  }
  growthDf<-growthDf %>% mutate(Sample = samplename)
return(growthDf)
}
ReadAggregateFile<-function(file, position, timepoint){#This function outputs total number of pixels in the csv file from matlab
  datos <-read.csv(file, header = TRUE)
  colnames(datos)<-c('Size', 'Species')
  datos<-datos %>% mutate(Position = position)
  datos<-datos %>% mutate(TimePoint = timepoint)
  return(datos)
}
wtAggregates<-MapAggregates(PA14wt, names3)
mutAggregates<-MapAggregates(PA14mut, names3)
Pa01Results<-MapAggregates(PA01wt, names2)
Pa01mutResults<-MapAggregates(PA01mut, 'rep1')
```
##Biomass per slice.  

Where is the majority of the biomass at any given time? and how does it grow over time.
It additionally helps identify how reproducible are the experiments
```{r Biomass per slice }
#This function uses facets to show the abundance of cells according to height over time
GraphSlices<-function (data, bug, facete){
  #first which bug is being selected
  if(bug=="Sa"){data <-data %>% filter(Species == "Sa")%>% filter(!Condition == "Pa Mono");nombre<-"S. aureus"}
  if(bug=="Pa"){data<-data %>% filter(Species == "Pa")%>% filter(!Condition == "Sa Mono");nombre<-"P. aeruginosa"}
  #then what kind of facet can be used
  if(missing(facete)){facete=facet_grid(Condition~TimePoint);condicion <- "Strain";forma <- NULL}
  else{facete <-facet_wrap(.~TimePoint,ncol = 6 );condicion <- "Condition";forma<-"Strain"}
  ggplot()+
    geom_point(data=data, aes_string(x="ZDistance", y="Value", color = condicion, shape = forma),size=1)+
    scale_y_log10(name=expression(paste('Biomass from voxel counts' )), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
    #labs(title =expression(paste(italic(nombre), " biomass value per slice in SCFM2" )),  x = "Distance from bottom (z-slice)")+
    labs(title =paste0(nombre, " biomass value per slice in SCFM2" ),  x = "Distance from bottom (z-slice)")+
    facete
}
ggsave("Sa z-slice condition-timepoint1.png", plot = GraphSlices(ResultsData, "Sa"), path = figuresPath)
ggsave("Sa z-slice timepoint.png", plot = GraphSlices(ResultsData, "Sa", "BLAH"), path = figuresPath)
ggsave("Pa z-slice condition-timepoint.png", plot = GraphSlices(ResultsData, "Pa"), path = figuresPath)
ggsave("Pa z-slice timepoint.png", plot = GraphSlices(ResultsData, "Pa", "BLAH"), path = figuresPath)
#This graph shows how the distribution of biomass changes over time per experiment.
GraphSlicesTime<-function(datos, bug, strain){
  if(bug=="Sa"){datos<-datos %>% filter(Species == "Sa")%>% filter(!Condition == "Pa Mono");nombre<-"S. aureus"}
  if(bug=="Pa"){datos<-datos %>% filter(Species == "Pa")%>% filter(!Condition == "Sa Mono");nombre<-"P. aeruginosa"}
  ggplot()+
    geom_point(data=datos %>% filter(Strain == strain) , aes(x=ZDistance, y=Value, color = TimePoint),size=1)+
    scale_y_log10(name=expression(paste('Biomass from voxel counts' )), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
    labs(title =paste(bug, "biomass value per slice in SCFM2 using",strain  ),  x = "Distance from bottom (z-slice)")+
    facet_grid(Sample~Condition)
}
ggsave("Sa z-slice PA14wt grid.png", plot = GraphSlicesTime(ResultsData, "Sa", "PA14wt"), path = figuresPath)
ggsave("Sa z-slice PA14mut grid.png", plot = GraphSlicesTime(ResultsData, "Sa", "PA14mut"), path = figuresPath)
ggsave("Pa z-slice PA14wt grid.png", plot = GraphSlicesTime(ResultsData, "Pa", "PA14wt"), path = figuresPath)
ggsave("Pa z-slice PA14mut grid.png", plot = GraphSlicesTime(ResultsData, "Pa", "PA14mut"), path = figuresPath)
```

#Images with new threshold
This threshold is the one calculated with the average of all the conditions
```{r new threshold images}
#To get the data from the new results folder I have to rewrite this function: 
GetResults<-function(sample, samplename){
  folder<- paste0('/Users/jupabago/Documents/Whiteley/PROJECTS/PaSaProject/Spatial paper Data/Microscopy Data/Other Data1/',sample,'/results')
  #the path just needs to be changed to"Other Data1"
  fileList<-list.files(path = folder, full.names = TRUE)
  growthDf<-data.frame()
  for (position in 0:5){
    currentPosition<-fileList[grep(paste0("p",position,"."),fileList)]
    for (timepoint in 0:17){
      currentTimePoint<-currentPosition[grep(paste0("t",GetNumber(timepoint),"_"),currentPosition)]
      growthDf<-rbind(growthDf,ReadResultsFile(currentTimePoint, position, timepoint))}}
  growthDf<-growthDf %>% mutate(Sample = samplename)
return(growthDf)
}
#This is also useful so that I know how the pipeline works
#first run MapResults which gets you all the data:
wtResults1<-MapResults(PA14wt, names3)
mutResults1<-MapResults(PA14mut, names3)
#combine them:
ResultsData1<-rbind(wtResults1,mutResults1)
#Get stats:
cleanResults1<-ResultsData1 %>% group_by(TimePoint,Sample,Strain,Condition,Species) %>% summarise(Totals = sum (Value))%>% mutate(LogTotals = ifelse(Totals>0, log10(Totals), 0))#this adds up all the data on each slice and then gets the log of that total
cleanResultsStats1<-cleanResults1 %>% group_by(TimePoint,Strain,Condition,Species) %>% summarise(MeanTotals = mean(Totals), SDTotals = sd(Totals), MeanLogTotals = mean(LogTotals), SDLogTotals = sd(LogTotals)) %>% mutate(MeanLogTotalsRevd = 10^MeanLogTotals, SDLogTotalsRevd =10^(SDLogTotals))
#Graph
#This Graphs the raw results
GraphGrowthCurves(cleanResults%>%filter(Strain%in%c("PA14wt","PA14mut")),cleanResultsStats%>%filter(Strain%in%c("PA14wt","PA14mut")),"Sa")
GraphGrowthCurves(cleanResults1,cleanResultsStats1, "Sa")
#This graphs the mean of the log totals along with the log of the totals themselves
GraphGrowthCurvesExp(cleanResults%>%filter(Strain%in%c("PA14wt","PA14mut")),cleanResultsStats%>%filter(Strain%in%c("PA14wt","PA14mut")), "Sa")
GraphGrowthCurvesExp(cleanResults1,cleanResultsStats1, "Sa")
#This graphs only the mean of the log values, no other points
GraphGrowthCurvesExpClean(cleanResults%>%filter(Strain%in%c("PA14wt","PA14mut")),cleanResultsStats%>%filter(Strain%in%c("PA14wt","PA14mut")), "Sa")
GraphGrowthCurvesExpClean(cleanResults1,cleanResultsStats1, "Sa")
#Isolate Sa
cleanResultsSa1 <- cleanResults1 %>% filter(Species == "Sa")
cleanResultsSaMono1<- cleanResultsSa1 %>% filter(Condition == "Sa Mono")
ggplot()+
  geom_point(data=cleanResultsSa1 %>% filter(Condition == "Sa Mono"), aes(x=TimePoint, y=Totals),  color = "Black", size=2)+
  geom_smooth(data=cleanResultsSaMono1, aes(x=TimePoint, y=Totals), size=3, color = "red")+
  scale_y_log10(limits= c(1e4,1e7), name=expression(paste('Biomass from voxel counts' )), breaks = c(10^(seq(5,10,.5))), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  labs(title =expression(paste(italic("S. aureus"), " growth in mono in SCFM2" )),  x = "Time (hours)",shape = "Culture condition", color = "Antiobiotic/Control") 

#Now for Pa
GraphGrowthCurvesExp(cleanResults1,cleanResultsStats1, "Pa")
GraphGrowthCurvesExpClean(cleanResults1,cleanResultsStats1, "Pa")
GraphGrowthCurvesExpCleanCoCulture<-function (dataStats){
  ggplot()+
    geom_line(data=dataStats %>% filter(!Condition %in% c("Pa Mono", "Sa Mono")), aes(x=TimePoint, y=MeanLogTotals,  color = Strain, linetype = Species), size=2)+
    labs(title =paste("Growth in SCFM2" ),  x = "Time (hours)",shape = "Culture condition", color = "Antiobiotic/Control")+
    facet_grid(.~Condition)
}
GraphGrowthCurvesExpCleanCoCulture(cleanResultsStats1)
```

```{r threshold Sa by time}
#This function keeps getting changed but using the same name... so heads up on that
GetResults<-function(sample, samplename){
  folder<- paste0('/Users/jupabago/Documents/Whiteley/PROJECTS/PaSaProject/Spatial paper Data/Microscopy Data/Threshold by time/',sample,'/resultsByTime6')
  #folder<- paste0('/Volumes/Seagate Backup Plus Drive/Good images/',sample,'/resultsByTime6')
  fileList<-list.files(path = folder, full.names = TRUE)
  growthDf<-data.frame()
  #for (position in 2:3){
  #  currentPosition<-fileList[grep(paste0("p",position,"."),fileList)]
  currentPosition<-fileList[grep(paste0("p2."),fileList)]
    for (timepoint in 0:17){
      currentTimePoint<-currentPosition[grep(paste0("t",GetNumber(timepoint),"_"),currentPosition)]
      growthDf<-rbind(growthDf,ReadResultsFile(currentTimePoint, 2, timepoint))
      #growthDf<-rbind(growthDf,ReadResultsFile(currentTimePoint, position, timepoint))
      }
    #}
  growthDf<-growthDf %>% mutate(Sample = samplename)
return(growthDf)
}

ProcessResults <-function(){
  wt<-MapResults(PA14wt, names3)
  mut<-MapResults(PA14mut, names3)
  #combine them:
  results<-rbind(wt,mut)
  #Add up all the data on each slice and then gets the log of that total
  resultsSum<-results %>% group_by(TimePoint,Sample,Strain,Condition,Species)%>% 
    summarise(Totals = sum (Value))%>%
    mutate(LogTotals = ifelse(Totals>0, log10(Totals), 0))
  #get stats between replicates
  resultsStats<-resultsSum %>% group_by(TimePoint,Strain,Condition,Species) %>% 
    summarise(MeanTotals = mean(Totals), SDTotals = sd(Totals), MeanLogTotals = mean(LogTotals), SDLogTotals = sd(LogTotals)) %>% 
    mutate(MeanLogTotalsRevd = 10^MeanLogTotals, SDLogTotalsRevd =10^(SDLogTotals))
  results <- list(resultsSum,resultsStats)
  return(results)
} 
#this is super bad, but the way I am generating the seccessive "linearx" below is by manually changing the folder in the function "GetResults" above, running it and then storing the results using "ProcessResults" below... I know, it sucks, but it works
linear6<-ProcessResults()
linearThresholdGrowthCurves<-combine(cleanResults,cleanResults1,cleanResultsByTime,linear1[[1]],linear2[[1]],linear4[[1]],linear5[[1]],linear6[[1]])
linearThresholdGrowthCurvesStats<-combine(linear1[[2]],linear2[[2]],linear4[[2]],linear5[[2]],linear6[[2]])

#these are the first few sets of data:
ggplot()+
  geom_line(data=cleanResults%>% filter(Species == "Sa") %>% filter(Condition == "Pa:Sa 1:1"& Strain %in% c("PA14wt", "PA14mut")), aes(x=TimePoint, y=LogTotals),color = "Black", size=2)+
  geom_line(data=cleanResults1%>% filter(Species == "Sa") %>% filter(Condition == "Pa:Sa 1:1"& Strain %in% c("PA14wt", "PA14mut")), aes(x=TimePoint, y=LogTotals),color = "Red", size=2)+
  geom_line(data=cleanResultsByTime%>% filter(Species == "Sa") %>% filter(Condition == "Pa:Sa 1:1"& Strain %in% c("PA14wt", "PA14mut")), aes(x=TimePoint, y=LogTotals),color = "Blue", size=2)+
  geom_line(data=linear1[[1]]%>% filter(Species == "Sa") %>% filter(Condition == "Pa:Sa 1:1"& Strain %in% c("PA14wt", "PA14mut")), aes(x=TimePoint, y=LogTotals),color = "Green", size=2)+
  facet_grid(Strain~Sample)+
  theme_cowplot(12)

ggplot()+
  geom_line(data=linearThresholdGrowthCurves%>% filter(Species == "Sa") %>% 
              filter(Condition == "Pa:Sa 1:1"& Strain %in% c("PA14wt", "PA14mut")), aes(x=TimePoint, y=LogTotals,color = source), size=2)+
  facet_grid(Strain~Sample)+
  theme_cowplot(12)

ggplot()+
  geom_line(data=linearThresholdGrowthCurvesStats%>% filter(Species == "Sa") %>% 
              filter(Condition == "Pa:Sa 1:1"& Strain %in% c("PA14wt", "PA14mut")), aes(x=TimePoint, y=MeanLogTotals,color = source), size=2)+
  facet_grid(Condition~Strain)+
  theme_cowplot(12)

```

```{r Pa Growth curves from RedSubtracted Images}
#This will give us a sense on how much of the Pa data was erased because it overlapped with the Sa data.
GetResults<-function(sample, samplename){
  folder<- paste0('/Users/jupabago/Documents/Whiteley/PROJECTS/PaSaProject/Spatial paper Data/Microscopy Data/RedSubtractedImages/',sample,'/resultsSubtractRed1')
  #folder<- paste0('/Volumes/Seagate Backup Plus Drive/Good images/',sample,'/resultsByTime6')
  fileList<-list.files(path = folder, full.names = TRUE)
  growthDf<-data.frame()
  #for (position in 2:3){
  #  currentPosition<-fileList[grep(paste0("p",position,"."),fileList)]
  currentPosition<-fileList[grep(paste0("p2."),fileList)]
    for (timepoint in 0:6){
      currentTimePoint<-currentPosition[grep(paste0("t",GetNumber(timepoint),"_"),currentPosition)]
      growthDf<-rbind(growthDf,ReadResultsFile(currentTimePoint, 2, timepoint))
      #growthDf<-rbind(growthDf,ReadResultsFile(currentTimePoint, position, timepoint))
      }
    #}
  growthDf<-growthDf %>% mutate(Sample = samplename)
return(growthDf)
}

redSubtractedData<-ProcessResults()#This was run using the "GetResults" function at the top..
paRedSubtractResults<-redSubtractedData[[1]]%>% filter(Species == "Pa") %>% filter(Condition == "Pa:Sa 1:1"& Strain %in% c("PA14wt", "PA14mut"))
nonSubtractedData<-ProcessResults()
paNonSubtractResults<-nonSubtractedData[[1]]%>% filter(Species == "Pa") %>% filter(Condition == "Pa:Sa 1:1"& Strain %in% c("PA14wt", "PA14mut"))

ggplot()+
  geom_line(data=redSubtractedData[[1]]%>% filter(Species == "Pa") %>% filter(Condition == "Pa:Sa 1:1"& Strain %in% c("PA14wt", "PA14mut")), aes(x=TimePoint, y=LogTotals),color = "red", size=2)+
  geom_line(data=nonSubtractedData[[1]]%>% filter(Species == "Pa") %>% filter(Condition == "Pa:Sa 1:1"& Strain %in% c("PA14wt", "PA14mut")), aes(x=TimePoint, y=LogTotals),color ="blue", size=2)+
  facet_grid(Strain~Sample)+
  theme_cowplot(12)

ggplot()+
  geom_line(data=redSubtractedData[[2]]%>% filter(Species == "Pa") %>% 
              filter(Condition == "Pa:Sa 1:1"& Strain %in% c("PA14wt", "PA14mut")), aes(x=TimePoint, y=MeanLogTotals,color = Strain), size=2)+
  theme_cowplot(12)

```
#Functions for histograms
```{r new threshold images aggregates functions and data collection}
GetAggregates<-function(sample, samplename){
  folder<- paste0('/Users/jupabago/Documents/Whiteley/PROJECTS/Spatial paper Data/Microscopy Data/Other Data1/', sample, '/aggregateSizes1')
  fileList<-list.files(path = folder, full.names = TRUE)
  growthDf<-data.frame()
  for (position in 0:5){
    currentPosition<-fileList[grep(paste0("p_",position,"."),fileList)]
    for (timepoint in 0:17){
      currentTimePoint<-currentPosition[grep(paste0("t_",GetNumber(timepoint),"p_"),currentPosition)]
      growthDf<-rbind(growthDf,ReadAggregateFile(currentTimePoint, position, timepoint))
      }
  }
  growthDf<-growthDf %>% mutate(Sample = samplename)
return(growthDf)
}

wtAggregates1<-MapAggregates(PA14wt, names3)
mutAggregates1<-MapAggregates(PA14mut, names3)
allAggregates<-bind_rows(wtAggregates1,mutAggregates1)
allAggregates1<-allAggregates %>% filter(!Size<0.5) %>% filter(!(Position==1 & Species=="Sa")) %>% filter(!(Position==0 & Species=="Pa"))%>% filter(!Species =="")
allAggregates1$Strain<-as.factor(allAggregates1$Strain)
allAggregates1$Sample<-as.factor(allAggregates1$Sample)
allAggregates1$TimePoint<-as.factor(allAggregates1$TimePoint)
allAggregates1$Position<-as.factor(allAggregates1$Position)
allAggregates1<-allAggregates1 %>% mutate(Condition = recode(Position, "0" = "Sa Mono", "1" = "Pa Mono", "2" = "Pa:Sa 1:1", "3" = "Pa:Sa 10:1", "4" = "Pa:Sa 1:100", "5" = "Pa:Sa 1:10" ))

```

```{r new threshold agggregates, include=FALSE}
#get some stats on aggregates
allDataSummary<-allAggregates1 %>% group_by(Species, Condition, TimePoint, Sample, Strain) %>% summarise(Aggs = n(), biomass = sum(Size), meanAggSize = mean(Size), sDAggSize = sd(Size), maxSize = max(Size), minSize = min(Size))
SaSummary<-allDataSummary %>% filter(Species == "Sa" & TimePoint == 7 & Condition == "Sa Mono") %>% ungroup()%>% summarise(MeanAgg = mean(meanAggSize) )

##Figure 6
#Summary figure for total aggregate numbers
ggplot()+
  geom_jitter(data = allDataSummary, aes(x = TimePoint, y= Aggs, color = Species, shape = Strain), width = 0, height = 0)+
  geom_smooth(data = allDataSummary, aes(x = TimePoint, y= Aggs, color = Species, linetype = Strain, group = interaction(Species, Strain)))+
  facet_wrap(.~Condition)+
  scale_y_continuous(limits= c(0,1e4))+
  ggtitle('Number of aggregates per experiment')+
  labs(x = "Time (hours)",y = "Number of Aggregates") 
#this is a decent outline of the aggregates but I need to still subset it
ggplot()+
  geom_point(data = allDataSummary, aes(x = TimePoint, y= meanAggSize, color = Species,shape = "Mean"))+
  geom_point(data = allDataSummary, aes(x = TimePoint, y= maxSize, color = Species, shape = "Max"))+
  geom_point(data = allDataSummary, aes(x = TimePoint, y= biomass, color = Species, shape = "Total"))+  
  geom_smooth(data = allDataSummary, aes(x = TimePoint, y= meanAggSize, color = Species, linetype = Strain, group = interaction(Species)))+
  facet_wrap(Strain~Condition)+
  scale_y_log10( breaks = scales::trans_breaks("log10", function(x) 10^x), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  ggtitle('Aggregates summary: Mean, largest and total biomass')+
  labs(x = "Time (hours)",y = "Biomass")+
  scale_shape_manual(name="Metric",values=c(Mean=1, Max=2, Total=17)) 
  
#this led me to introduce another metric: ratio of largest aggregate to total biomass
allDataSummary<-allDataSummary %>% mutate(RatioMaxTotal = maxSize/biomass )

ggplot()+
  geom_jitter(data = allDataSummary, aes(x = TimePoint, y= RatioMaxTotal, color = Species, shape = Strain), width = 0, height = 0)+
  geom_hline(yintercept=1, linetype = "dashed")+
  geom_smooth(data = allDataSummary, aes(x = TimePoint, y= RatioMaxTotal, color = Species, linetype = Strain, group = interaction(Species, Strain)))+
  facet_wrap(.~Condition)+
  ggtitle('Ratio of largest aggregate to total biomass')+
  labs(x = "Time (hours)",y = "Proportion of largest aggregate to total biomass")
#this seems to have a lot of noise, how does that compare to actual biomass?
ggplot()+
  geom_jitter(data = allDataSummary, aes(x = TimePoint, y= biomass, color = Species, shape = Strain), width = 0, height = 0)+
  geom_smooth(data = allDataSummary, aes(x = TimePoint, y= biomass, color = Species, linetype = Strain, group = interaction(Species, Strain)))+
  scale_y_log10( breaks = scales::trans_breaks("log10", function(x) 10^x), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  facet_wrap(.~Condition)+
  ggtitle("Total biomass")+
  labs(x = "Time (hours)",y = "Total biomass")
```

#Aggregate histograms
```{r Aggregate histograms functions}
FancyHistogram<-function(df, sec){#my own way of doing histograms which includes the sum and mean of values whitin each bin
  results<-data.frame()
  for( i in 1:(length(sec)-1)){
    df %>% filter(Size > sec[i] &Size<=sec[i+1])%>%summarise(frequency = n(), avg = mean(Size),suma = sum(Size)) %>% mutate(bin = i, min = sec[i],max = sec[i+1])->blah 
    if(blah$frequency>0){
    results<-rbind(results, blah)}
  }
  return(results)
  }
TotalFancyHistogram<-function(df,binsize){
  totalbiomass<-sum(df$Size)#total biomass per sample
  totalfrequency<-length(df$Size)#total number of objects
  upperLim<-max(df$Size)+binsize-(max(df$Size)%%binsize)#largest bin size based in largest object
  breaksSequence<-seq(0,upperLim,binsize)#this makes breaks every "binsize" 
  histogram<-FancyHistogram(df,breaksSequence)#apply "fancy histogram" to get distributions
  histogram%>%mutate(BiomassBin=suma/totalbiomass)->histogram#add column with proportion of biomas per bin
  histogram%>%mutate(Density=frequency/totalfrequency)->histogram#add column with proportion of counts per bin
  histogram%>%mutate(Species=df$Species[1])->histogram#add column maintaining sample and so on...
  histogram%>%mutate(Condition=df$Condition[1])->histogram
  histogram%>%mutate(TimePoint=df$TimePoint[1])->histogram
  histogram%>%mutate(Sample=df$Sample[1])->histogram
  histogram%>%mutate(Strain=df$Strain[1])->histogram
  return(histogram)
}
TotalHistogram<-function(df){
  biomass<-df$Size
  totalbiomass<-sum(biomass)
  upperLim<-max(biomass)+5-mod(max(biomass),5)
  breaksSequence<-seq(0,upperLim,5)#this makes breaks every 100 pixels
  histogram<-data.frame()
  currentHist<-hist(biomass, plot = F, breaks = breaksSequence)
  histogram<-data.frame(currentHist$counts,currentHist$mids)
  colnames(histogram)<-c("Counts", "Midpoint")
  histogram<-histogram[!(histogram$Counts==0),]#remove zeros
  histogram%>%mutate(BiomassBin=Counts*Midpoint)->histogram
  histogram%>%mutate(NormBiomassBin=BiomassBin/totalbiomass)->histogram
  return(histogram)
}

##This is done just once, afterwards I just pull them up from the csv file since it takes some time to get them.
#group them to get histograms for each experimental condition
allData<-allAggregates1 %>% group_by(Species, Condition, TimePoint, Sample, Strain)#first do the correct grouping
aggregatesList<- group_split(allData)#create list of dataframes
allDataHistograms.5<-map2(aggregatesList, 5,TotalFancyHistogram)#apply histogram function to all items in the list
allDataHistograms.10<-map2(aggregatesList, 10,TotalFancyHistogram)#apply histogram function to all items in the list
allDataHistograms.50<-map2(aggregatesList, 50,TotalFancyHistogram)#apply histogram function to all items in the list
allDataHistograms.100<-map2(aggregatesList, 100,TotalFancyHistogram)#apply histogram function to all items in the list

allDataHistograms.5df<- bind_rows(allDataHistograms.5)
allDataHistograms.10df<- bind_rows(allDataHistograms.10)
allDataHistograms.50df<- bind_rows(allDataHistograms.50)
allDataHistograms.100df<- bind_rows(allDataHistograms.100)

write.csv(allDataHistograms.5df, file = '/Users/jupabago/Documents/Whiteley/PROJECTS/Spatial paper Data/Microscopy Data/Histograms1/histograms5.csv')
write.csv(allDataHistograms.10df,file = '/Users/jupabago/Documents/Whiteley/PROJECTS/Spatial paper Data/Microscopy Data/Histograms1/histograms10.csv')
write.csv(allDataHistograms.50df,file = '/Users/jupabago/Documents/Whiteley/PROJECTS/Spatial paper Data/Microscopy Data/Histograms1/histograms50.csv')
write.csv(allDataHistograms.100df,file = '/Users/jupabago/Documents/Whiteley/PROJECTS/Spatial paper Data/Microscopy Data/Histograms1/histograms100.csv')
```

```{r new threshold images histogram plots}
allDataHistograms.5df<-read.csv(file='/Users/jupabago/Documents/Whiteley/PROJECTS/Spatial paper Data/Microscopy Data/Histograms1/histograms5.csv',header=T)
allDataHistograms.10df<-read.csv(file='/Users/jupabago/Documents/Whiteley/PROJECTS/Spatial paper Data/Microscopy Data/Histograms1/histograms10.csv',header=T)
allDataHistograms.50df<-read.csv(file='/Users/jupabago/Documents/Whiteley/PROJECTS/Spatial paper Data/Microscopy Data/Histograms1/histograms50.csv',header=T)
allDataHistograms.100df<-read.csv(file='/Users/jupabago/Documents/Whiteley/PROJECTS/Spatial paper Data/Microscopy Data/Histograms1/histograms100.csv',header=T)
allDataHistograms.100df<-allDataHistograms.100df %>% mutate(Coculture = recode(Condition, "Sa Mono" = "No", "Pa Mono" = "No", "Pa:Sa 1:1" = "Yes","Pa:Sa 10:1"= "Yes", "Pa:Sa 1:100" = "Yes", "Pa:Sa 1:10" = "Yes"))
allDataHistograms.5df<-allDataHistograms.5df %>% mutate(Coculture = recode(Condition, "Sa Mono" = "No", "Pa Mono" = "No", "Pa:Sa 1:1" = "Yes","Pa:Sa 10:1"= "Yes", "Pa:Sa 1:100" = "Yes", "Pa:Sa 1:10" = "Yes"))
  
plotHist3DBiomassCountsLog<-function(df1, title){
  ggplot()+
    geom_point(data=df1,aes(x=max, y=frequency, color = Coculture, shape = Condition))+
    scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
    scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
    xlab('Biomass (um^3)')+
    ylab('Frequency')+
    ggtitle(paste0(title," Raw biomass Distribution (bin size = 100 um)"))+
    facet_wrap(~TimePoint, nrow=4)
}
#This shows that the Sa biomass that gets eaten by Staph is from the largest aggregates, not from the small ones
plotHist3DBiomassCountsLog(allDataHistograms.100df %>% filter(Species == "Sa"), "Sa co-culture vs mono")
plotHist3DBiomassCountsLog(allDataHistograms.100df %>% filter(Species == "Pa"), "Pa co-culture vs mono")

plotHist3DBiomassCounts<-function(df1, title){
  ggplot()+
    geom_point(data=df1,aes(x=max, y=frequency, color = Strain, shape = Sample))+
    scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
    xlab('Biomass (um^3)')+
    ylab('Frequency')+
    ggtitle(paste0(title," Raw biomass Distribution (bin size = 5 um)"))+
    facet_wrap(~TimePoint, nrow=4)
}
#this shows how different ratios work to delay the dissapearance of large aggregates of staph in the samples
plotHist3DBiomassCounts(allDataHistograms.5df%>%filter(Species=="Sa") %>% filter(Condition == "Pa:Sa 1:100")%>% filter(max<101),"Sa in Pa:Sa 1:100 only")
plotHist3DBiomassCounts(allDataHistograms.5df%>%filter(Species =="Sa") %>% filter(Condition=="Pa:Sa 1:10")%>% filter(max<101),"Sa in Pa:Sa 1:10 only")
plotHist3DBiomassCounts(allDataHistograms.5df%>%filter(Species == "Sa") %>%filter(Condition=="Pa:Sa 10:1")%>% filter(max<101),"Sa in Pa:Sa 10:1 only")
#this shows how early or late large aggregates of pseudomonas appear according to the ratio
plotHist3DBiomassCounts(allDataHistograms.5df%>%filter(Species=="Pa") %>% filter(Condition == "Pa:Sa 1:100")%>% filter(max<101),"Pa in Pa:Sa 1:100 only")
plotHist3DBiomassCounts(allDataHistograms.5df%>%filter(Species =="Pa") %>% filter(Condition=="Pa:Sa 1:10")%>% filter(max<101),"Pa in Pa:Sa 1:10 only")
plotHist3DBiomassCounts(allDataHistograms.5df%>%filter(Species == "Pa") %>%filter(Condition=="Pa:Sa 10:1")%>% filter(max<101),"Pa in Pa:Sa 10:1 only")

#This plots how much biomass is on each bin, it should be exponential in y-axis, but I don't think it is super useful
plotHist3DBiomassBinBiomass<-function(df1, title, binSize){
  ggplot()+
    geom_point(data=df1,aes(x=max, y=suma, color = Strain, shape = Condition))+
    scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
    scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
    xlab('Bin size')+
    ylab('Biomass (um^3)')+
    ggtitle(paste0("Total Biomass per bin (bin size = ",binSize," um) ",title))+
    facet_wrap(~TimePoint, nrow=4)
}
plotHist3DBiomassBinBiomass(allDataHistograms.100df %>% filter(Species == "Sa") %>% filter (Coculture=="No"), "Sa co-culture vs mono", "100")

#This shows how much of the total biomass is on each bin. it should just go from 0 to one, so not a great idea to make it exponential.
plotHist3DBiomassNormBinBiomass<-function(df1, title, binSize){
  ggplot()+
    geom_point(data=df1,aes(x=max, y=BiomassBin, color = Strain, shape = Sample))+
    scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
    scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
    xlab('Bin size')+
    ylab('Contribution to total biomass')+
    ggtitle(paste0("Biomass contribution per bin (bin size = ",binSize," um) ",title))+
    facet_wrap(~TimePoint, nrow=4)
}
#binsize of 100
plotHist3DBiomassNormBinBiomass(allDataHistograms.100df %>% filter(Species == "Sa") %>% filter (Coculture=="No"), "Sa mono culture", "100")
plotHist3DBiomassNormBinBiomass(allDataHistograms.100df %>% filter(Species == "Pa") %>% filter (Coculture=="No"), "Pa mono culture", "100")

plotHist3DBiomassNormBinBiomass<-function(df1, title, binSize){
  ggplot()+
    geom_point(data=df1,aes(x=max, y=BiomassBin, color = Strain, shape = Condition))+
    scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
    scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
    xlab('Bin size')+
    ylab('Contribution to total biomass')+
    ggtitle(paste0("Biomass contribution per bin (bin size = ",binSize," um) ",title))+
    facet_wrap(~TimePoint, nrow=4)
}
plotHist3DBiomassNormBinBiomass(allDataHistograms.100df %>% filter(Species == "Sa") %>% filter (Coculture=="Yes"), "Sa co-cultures", "100")
plotHist3DBiomassNormBinBiomass(allDataHistograms.100df %>% filter(Species == "Pa") %>% filter (Coculture=="Yes"), "Pa co-cultures", "100")

#binsize of 5
plotHist3DBiomassNormBinBiomass(allDataHistograms.5df%>% filter(Species == "Sa") %>% filter (Coculture=="No")%>% filter(max<101), "Sa mono culture", "5")
plotHist3DBiomassNormBinBiomass(allDataHistograms.5df%>% filter(Species == "Pa") %>% filter (Coculture=="No")%>% filter(max<101), "Pa mono culture", "5")


```
