---
title: "PropOcData2"
author: "Juan P Barraza"
date: "3/5/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(pixmap)
library(rtiff)
library(reshape2)
library(gplots)
library(gdata)
library(plyr)
library(dplyr)
library(ggplot2)
library(cowplot)
library(tidyr)
library(purrr)
library(plotrix)
library(ggsignif)
library(rdist)

source('/Users/jupabago/Documents/Whiteley/PROJECTS/Rpackage/PropOc Package/R/PropOcFunctions2.0.R') 
#using the new 3D script with capped spheres.
```

```{r PropOc DATA}

GetPropOcData<-function(sample, timepoints, positions){
  folder<- paste0('/Volumes/Seagate Backup Plus Drive/Good images/',sample,'/imagesSubtractRed')
  growthDf<-data.frame()#data frame to add all timepoints and positions
  fileList<-list.files(path = folder, full.names = TRUE)
  print(folder)
  for (position in 0:positions){
    currentPosition<-fileList[grep(paste0("p",position,"_"),fileList)]
    print(paste0('analyzing position ', position))
    for (timepoint in 0:timepoints){
      currentTimePoint<-currentPosition[grep(paste0("t",GetSlice(timepoint),"_"),currentPosition)]
      dataTimePoint<-NormRawPipeline(SlicesTo3D(currentTimePoint,"red"),SlicesTo3D(currentTimePoint,"green"), 
                                     xydimSearch=114,zdimSearch = 70, sampleSize=1000,xyRealDim=0.264,
                                     zRealDim = 0.44, pipeBinSize = 1)
      dataTimePoint$TimePoint <- timepoint
      dataTimePoint$Position <- position
      growthDf<-rbind(growthDf,dataTimePoint)
      }
    }
  return(growthDf)
  }

GetSlice<-function(idx){
if (idx<10){num = paste0(0,idx)}
  else
    {num = idx}
  return(num)}
```
```{r run them}
wt1<-GetPropOcData("3-13-19",6,2)
wt2<-GetPropOcData("3-19-19",6,2)
wt3<-GetPropOcData("4-17-19",6,2)
mut1<-GetPropOcData("4-24-19",6,2)
mut2<-GetPropOcData("4-25-19",6,2)
mut3<-GetPropOcData("5-8-19",6,2)


```

```{r Read data files}
GetGrowthCurveReplicate<- function (sample){
  bugCounts<-read.csv(paste0("/Users/jupabago/Documents/Whiteley/PROJECTS/PaSaProject/Spatial paper Data/GrowthCurves/", sample, ".csv"),header = TRUE)
  bugCounts<- na.omit(bugCounts)
  bugCounts<-bugCounts %>% mutate(logCFU = log10(CFU))
  bugCounts$sample<-sample
  return(bugCounts)
}

Get3DPropOcData<-function(strain, biologicalRep){
  propOcData1<-read.csv(paste0("/Users/jupabago/Documents/Whiteley/PROJECTS/PaSaProject/Spatial paper Data/Microscopy Data/3D PropOc Data/", strain,biologicalRep,"-1000-",1,".csv"),header = T)
  propOcData1<-propOcData1 %>% mutate(Strain = strain,BioRep = biologicalRep, RunRep = 1)
  propOcData2<-read.csv(paste0("/Users/jupabago/Documents/Whiteley/PROJECTS/PaSaProject/Spatial paper Data/Microscopy Data/3D PropOc Data/", strain,biologicalRep,"-1000-",2,".csv"),header = T)
  propOcData2<-propOcData2 %>% mutate(Strain = strain,BioRep = biologicalRep, RunRep = 2)
  propOcData3<-read.csv(paste0("/Users/jupabago/Documents/Whiteley/PROJECTS/PaSaProject/Spatial paper Data/Microscopy Data/3D PropOc Data/", strain,biologicalRep,"-1000-",3,".csv"),header = T)
  propOcData3<-propOcData3 %>% mutate(Strain = strain,BioRep = biologicalRep, RunRep = 3)
  allData<-bind_rows(propOcData1,propOcData2,propOcData3)
  allData<-allData %>% mutate(Relation = recode(source, "finalGG" = "Pa->Pa","finalRG" = "Sa->Pa","finalRR" = "Sa->Sa","finalGR" = "Pa->Sa"))%>%mutate(Condition = recode(Position, "2" = "Pa:Sa 1:1"))%>%mutate(Interaction = recode(source, "finalGG" = "Self","finalRG" = "Other","finalRR" = "Self","finalGR" = "Other"))
  allData<-allData %>% filter(TimePoint<6 & Distance<30)
  }
wt1<-Get3DPropOcData("wt", 1)
wt1<-wt1 %>% filter(!TimePoint==1 | !RunRep==2)
wt2<-Get3DPropOcData("wt", 2)
wt3<-Get3DPropOcData("wt", 3)
mut1<-Get3DPropOcData("mut", 1)
mut2<-Get3DPropOcData("mut", 2)
mut2<-mut2 %>% filter(!TimePoint==3 | !RunRep==2)
mut3<-Get3DPropOcData("mut", 3)
mut3<-mut3 %>% filter(!TimePoint==1 | !RunRep==2)

```
```{r checking the replicate runs}
PlotPropOcAll <- function(df, name) {
ggplot()+
  geom_point(data=df, aes(x=Distance,y=MeanPropOcc, color = Relation, shape = factor(RunRep)),size=4)+
  facet_wrap(TimePoint~Relation, ncol = 4)+
  scale_y_log10( breaks = scales::trans_breaks("log10", function(x) 10^x), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  labs(title =name)+
  theme_cowplot()+
  background_grid()
}
PlotPropOcAll(wt1,"wt1")
PlotPropOcAll(wt2,"wt2")
PlotPropOcAll(wt3,"wt3")
PlotPropOcAll(mut1,"mut1 ")
PlotPropOcAll(mut2,"mut2")
PlotPropOcAll(mut3,"mut3")

```