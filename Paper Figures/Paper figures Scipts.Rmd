---
title: "Paper Figures and Data"
author: "Juan P Barraza"
date: "12/14/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r data Figure 1, include=FALSE}
#Data gathering functions:
GetGrowthCurveReplicate<- function (sample){
  bugCounts<-read.csv(paste0("/Users/jupabago/Documents/Whiteley/PROJECTS/PaSaProject/Spatial paper Data/GrowthCurves/", sample, ".csv"),header = TRUE)
  bugCounts<- na.omit(bugCounts)
  bugCounts<-bugCounts %>% mutate(logCFU = log10(CFU))
  bugCounts$sample<-sample
  return(bugCounts)
}
GetGrowthCurveCondition<-function(datalist){
  mappedData<-map(datalist, GetGrowthCurveReplicate)#this line reads all the files on the list
  boundData<-bind_rows(mappedData)
  colnames(boundData)[5] <- "strain"
  colnames(boundData)[8] <- "condition"
  return(boundData)
}

PA14 = c('2-11-19','2-7-19','2-5-19')
#get data
PA14Data<-GetGrowthCurveCondition(PA14)
PA14Data$strain <- factor(PA14Data$strain, levels = c("wt", "mut"))

#do stats
PA14DataStats<-PA14Data%>% group_by(condition, bug, time,strain) %>% summarise(CFUmean = mean (CFU), CFUsd = sd(CFU), CFUse = std.error(CFU), logCFUmean = mean (logCFU), logCFUsd = sd(logCFU),logCFUse = std.error(logCFU))
```

```{r code Figure 1}
GraphGrowthCurveLog1<-function (rawData, statsData){
    shakingWtPlot<-ggplot()+
      geom_line(data=statsData%>% filter(condition == "Shaking" & strain == "wt"), aes(x=time, y=logCFUmean, linetype = bug), size=.5)+
      geom_errorbar(data=statsData%>% filter(condition == "Shaking" & strain == "wt"),aes(x = time, ymin = logCFUmean-logCFUse, ymax=logCFUmean+logCFUse), width = 0, size = 0.5)+
      geom_hline(yintercept=9.619, color='red', linetype = "solid") + #Pa stirred
      geom_hline(yintercept=9.13, color='red', linetype = "dashed") + #Sa stirred
      scale_linetype_manual(values = c( "solid","dashed"), labels = c(bquote(paste(italic('P. aeruginosa'))),bquote(paste(italic('S. aureus')))))+
      labs(x = "Time (hours)", y = expression(paste(Log[10], " CFU")), linetype = "Species")+
      scale_y_continuous(limits = c(4,10))+
      scale_x_continuous(breaks = c(4,8,12,16))+
      theme_cowplot(12)
      
    staticWtPlot<-ggplot()+
      geom_line(data=statsData%>% filter(condition == "Static" & strain == "wt"), aes(x=time, y=logCFUmean, linetype = bug), size=.5)+
      geom_errorbar(data=statsData%>% filter(condition == "Static" & strain == "wt"),aes(x = time,ymin=logCFUmean-logCFUse, ymax = logCFUmean+logCFUse), width = 0, size = 0.5)+
      scale_linetype_manual(values = c( "solid","dashed"), labels = c("stirred","static"))+
      geom_hline(yintercept=8.88, color='red', linetype = "dashed") +
      geom_hline(yintercept=9.07, color='red', linetype = "solid") +
      labs(x = "Time (hours)", y = expression(paste(Log[10], " CFU")), linetype = "")+
      scale_y_continuous(limits=c(4,10))+
      scale_x_continuous(breaks = c(4,8,12,16))+
      theme_cowplot(12)
    
    legend <- get_legend(shakingWtPlot + theme(legend.box.margin = margin(0, 0, 0, -10)))
    prow <- plot_grid(shakingWtPlot+theme(legend.position="none"),staticWtPlot+theme(legend.position="none"),
                      align='vh',labels = c("Mixed", "Static"),hjust = c(-3, -3.8),nrow = 1)
    plot_grid(prow,legend,rel_widths = c(3, .4))
    }
#Graph logs
GraphGrowthCurveLog1(PA14Data,PA14DataStats)
```
Figures 2 and 5 are on document : "Staph killing assays.Rmd"

```{r Figure 4}
GraphGrowthCurveLog2<-function (rawData, statsData){
  shakingMutPlot<-ggplot()+
    geom_line(data=statsData%>% filter(condition == "Shaking" & strain ==  "mut"), aes(x=time, y=logCFUmean, linetype = bug), size=.5)+
    geom_errorbar(data=statsData%>% filter(condition == "Shaking" & strain == "mut"), aes(x = time, ymin = logCFUmean-logCFUse, ymax = logCFUmean+logCFUse), width = 0, size = 0.5)+
    scale_linetype_manual(values = c( "solid","dashed"), labels = c(bquote(paste(italic('P. aeruginosa'))),bquote(paste(italic('S. aureus')))))+
    geom_hline(yintercept=9.13, color='red', linetype = "dashed") +
    geom_hline(yintercept=9.57, color='red', linetype = "solid") +
    labs(x = "Time (hours)", y = expression(paste(Log[10], " CFU")), linetype = "Species")+
    scale_y_continuous(limits = c(4,10))+
    scale_x_continuous(breaks = c(4,8,12,16))+
    theme_cowplot(12)

  staticMutPlot<-ggplot()+
    geom_line(data=statsData%>% filter(condition == "Static" & strain == "mut"), aes(x=time, y=logCFUmean, linetype = bug), size=.5)+
    geom_errorbar(data=statsData%>% filter(condition == "Static" & strain ==  "mut"), aes(x = time, ymin = logCFUmean-logCFUse, ymax = logCFUmean+logCFUse), width = 0, size = 0.5)+
    scale_linetype_manual(values = c( "solid","dashed"), labels = c(bquote(paste(italic('P. aeruginosa'))),bquote(paste(italic('S. aureus')))))+
    geom_hline(yintercept=8.88, color='red', linetype = "dashed") +
    geom_hline(yintercept=8.98, color='red', linetype = "solid") +
    labs(x = "Time (hours)", y = expression(paste(Log[10], " CFU")), linetype = "")+
    scale_y_continuous(limits = c(4,10))+
    scale_x_continuous(breaks = c(4,8,12,16))+
    theme_cowplot(12)
  legend <- get_legend(shakingMutPlot + theme(legend.box.margin = margin(0, 0, 0, -10)))
  prow <- plot_grid(shakingMutPlot+theme(legend.position="none"),staticMutPlot+theme(legend.position="none"),
                      align='vh',labels = c("Mixed", "Static"),hjust = c(-3, -3.8),nrow = 1)
    plot_grid(prow,legend,rel_widths = c(3, .4))
}

#Graph logs
GraphGrowthCurveLog2(PA14Data,PA14DataStats)
```

```{r Tobramycin}
#data wrangling
cleanSCFM2DataTobSa <- newSCFMDataSa %>% group_by(timePoint, antibiotic, culture) %>% summarise(meanCFUratio = mean(ratioCFU), sdCFUratio = sd(ratioCFU),meanLogRatio = mean(ratiolog), sdLogRatio = sd(ratiolog))

#this is using CFUs
ggplot()+
  #geom_pointrange(data=cleanSCFM2DataTobSa,aes(x=timePoint, y = meanCFUratio, ymin = meanCFUratio - sdCFUratio, ymax = meanCFUratio + sdCFUratio, color = culture), size=1)+
  geom_point(data=cleanSCFM2DataTobSa,aes(x=timePoint, y = meanCFUratio, color = culture), size=3)+
  geom_errorbar(data=cleanSCFM2DataTobSa,aes(x=timePoint,ymin = meanCFUratio - sdCFUratio, ymax = meanCFUratio + sdCFUratio, color = culture), size=1)+
  #geom_vline(xintercept=3, linetype = "dashed")+
  scale_y_log10("Growth ratio compared to co-culture with wt", breaks = scales::trans_breaks("log10", function(x) 10^x), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  #annotate("text", x = 3, y = 10e6, label = "TOB added")+
  facet_grid(.~antibiotic)+
  labs(x = "Time (hours)", color="Culture condition", shape =  "Antiobiotic/Control") 

#This one is using logCFUs
ggplot()+
  geom_point(data=cleanSCFM2DataTobSa,aes(x=timePoint, y = meanLogRatio, color = culture), size=3)+
  geom_errorbar(data=cleanSCFM2DataTobSa,aes(x=timePoint,ymin = meanLogRatio - sdLogRatio, ymax = meanLogRatio + sdLogRatio, color = culture), size=.5, width = 0)+
  geom_hline(xintercept=3, linetype = "dashed")+
  scale_y_continuous(limits = c(.6,1.6 ))+
  #scale_y_log10("Growth ratio compared to co-culture with wt", breaks = scales::trans_breaks("log10", function(x) 10^x), labels = scales::trans_format("log10", scales::math_format(10^.x)),limits = c(10e-0.2,10e0.2))+
  annotate("text", x = 3, y = 1.4, label = "TOB added")+
  facet_grid(.~antibiotic)+
  labs(x = "Time (hours)", color="Culture condition", shape =  "Antiobiotic/Control") +
  theme_cowplot(12)

GraphTOBGrowthCurveLog<-function (){
    controlPlot<-ggplot()+
      geom_point(data=cleanSCFM2DataTobSa %>% filter(antibiotic=="Control", culture != "wt"),aes(x=timePoint, y = meanLogRatio, shape = culture), size=3)+
      geom_errorbar(data=cleanSCFM2DataTobSa%>% filter(antibiotic=="Control", culture != "wt"),aes(x=timePoint,ymin = meanLogRatio - sdLogRatio, ymax = meanLogRatio + sdLogRatio), size=.5, width = 0.2)+
      geom_hline(yintercept=1, linetype = "dashed")+
      scale_y_continuous(limits = c(.6,1.6 ))+
      labs(x = "Time (hours)", shape="Culture condition", y = "Log Growth ratio compared to wild-type co-culture ") +
      theme_cowplot(12)
    
    tobPlot<-ggplot()+
      geom_point(data=cleanSCFM2DataTobSa %>% filter(antibiotic=="TOB", culture != "wt"),aes(x=timePoint, y = meanLogRatio, shape = culture), size=3)+
      geom_errorbar(data=cleanSCFM2DataTobSa%>% filter(antibiotic=="TOB", culture != "wt"),aes(x=timePoint,ymin = meanLogRatio - sdLogRatio, ymax = meanLogRatio + sdLogRatio), size=.5, width = 0.2)+
      scale_y_continuous(limits = c(.6,1.6 ))+
      geom_hline(yintercept=1, linetype = "dashed")+
      labs(x = "Time (hours)", y = "", color="Culture condition") +
      theme_cowplot(12)
    
    legend <- get_legend(controlPlot + theme(legend.box.margin = margin(0, 200, 300,0)))
    prow <- plot_grid(controlPlot+theme(legend.position="none"),tobPlot+theme(legend.position="none"),align='vh',labels = c("A", "B"),hjust = -1,nrow = 1)
    plot_grid(prow,legend,rel_widths = c(3, .4))
    }
GraphTOBGrowthCurveLog()
```
```{r biomass}
GraphGrowthCurvesExpClean(cleanResults1 %>% filter(TimePoint<10),cleanResultsStats1%>% filter(TimePoint<10), "Sa")

countsFinal1<-countsFinal %>% mutate(logCounts = log10(cellCount)) %>% group_by(bug, condition) %>% mutate(meanLog = mean(logCounts), sdcounts = std.error(logCounts))

ggplot()+
  geom_jitter(data= countsFinal1, aes(x=condition, y= logCounts,  shape= condition),height = 0, width = .2, size = 1)+
  #geom_text(fontface = "bold",position=position_jitter(width=.5,height=0))+
  geom_point(data= countsFinal1, aes(x=condition, y= meanLog,shape= condition), size = 3)+
  geom_errorbar(data=countsFinal1,aes(x=condition,ymin = meanLog - sdcounts, ymax = meanLog + sdcounts), size=.5, width = 0.2)+
  #scale_y_log10(name="Mouse Wound CFU/mL", limits= c(1,1e8),breaks = scales::trans_breaks("log10", function(x) 10^x), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  ylim(2,8)+ 
  labs(x = "",  y = expression(paste(Log[10], " CFU")), shape="Strain")+
  facet_grid(.~bug)+
  theme_cowplot(12)

```

```{r invasion ratios graphs}
#functions to get data
GetResults<-function(sample, samplename){
  folder<- paste0('/Users/jupabago/Documents/Whiteley/PROJECTS/PaSaProject/Spatial paper Data/Microscopy Data/Other Data1/',sample,'/results')
  #the path just needs to be changed to"Other Data1"
  fileList<-list.files(path = folder, full.names = TRUE)
  growthDf<-data.frame()
  for (position in 0:5){
    currentPosition<-fileList[grep(paste0("p",position,"."),fileList)]
    for (timepoint in 0:17){
      currentTimePoint<-currentPosition[grep(paste0("t",GetNumber(timepoint),"_"),currentPosition)]
      growthDf<-rbind(growthDf,ReadResultsFile(currentTimePoint, position, timepoint))}}
  growthDf<-growthDf %>% mutate(Sample = samplename)
return(growthDf)
}
ReadResultsFile<-function(file, position, timepoint){
  datos <-read.csv(file, header = FALSE)
  colnames(datos)<-c('Red', 'Green', 'Slice')
  datos<-datos %>% mutate(Position = position)
  datos<-datos %>% mutate(TimePoint = timepoint)
  return(datos)
}
MapResults<- function(listSamples, reps){
  blah <-deparse(substitute(listSamples))
  mappedData<-map2(listSamples, reps, GetResults)
  boundData<-bind_rows(mappedData)
  boundData<-boundData %>% mutate(Strain = blah)
  boundData<-gather(boundData,"Color","Value",-Slice,-Position,-Sample,-TimePoint,-Strain) %>% mutate(LogValue=ifelse(Value>0,log10(Value),0))
  boundData<-boundData %>% mutate(Condition = recode(Position, "0" = "Sa Mono", "1" = "Pa Mono", "2" = "Pa:Sa 1:1", "3" = "Pa:Sa 10:1", "4" = "Pa:Sa 1:100", "5" = "Pa:Sa 1:10" )) %>% mutate(Species = recode(Color, "Red" = "Sa", "Green" = "Pa")) %>% mutate(ZDistance = Slice *0.44)
  boundData$Condition<-as.factor(boundData$Condition)
  boundData$Condition<-factor(boundData$Condition, levels = c("Sa Mono", "Pa Mono", "Pa:Sa 1:1", "Pa:Sa 1:10", "Pa:Sa 1:100","Pa:Sa 10:1"))
  boundData$Species<-as.factor(boundData$Species)
  boundData$Strain<-as.factor(boundData$Strain)
  return(boundData)
  }
PA14wt<- c('3-13-19', '3-19-19', '4-17-19')
PA14mut<- c('4-24-19', '4-25-19', '5-8-19')
names3<-c('rep1','rep2','rep3')
wtBiomassResults<-MapResults(PA14wt, names3)
mutBiomassResults<-MapResults(PA14mut, names3)

biomassData<-rbind(wtBiomassResults,mutBiomassResults)#combine data
#Add up all the data on each slice and then get the log of that total
biomassDataClean<-biomassData %>% 
  group_by(TimePoint,Sample,Strain,Condition,Species) %>% 
  summarise(Totals = sum (Value))%>% 
  mutate(LogTotals = ifelse(Totals>0, log10(Totals), 0))
#Get stats
biomassStats<-biomassDataClean %>% 
  group_by(TimePoint,Strain,Condition,Species) %>% 
  summarise(MeanTotals = mean(Totals), SDTotals = sd(Totals), MeanLogTotals = mean(LogTotals), SDLogTotals = sd(LogTotals)) %>%
  mutate(MeanLogTotalsRevd = 10^MeanLogTotals, SDLogTotalsRevd =10^(SDLogTotals))

biomassDataCleantEST <-biomassDataClean %>%filter(!Condition%in%c("Sa Mono", "Pa Mono")) %>% filter(TimePoint<7) %>% group_by(TimePoint, Sample, Strain, Condition) %>% mutate(RatioTotals = Totals[Species == "Pa"]/Totals[Species == "Sa"],LogDiff = LogTotals[Species == "Pa"]-LogTotals[Species == "Sa"]) %>% ungroup() %>% group_by(TimePoint,Strain,Condition,Species) %>% mutate(meanRatio = mean(RatioTotals), meanLogDiff = mean(LogDiff)) %>% ungroup()

ggplot()+#graph all data
  geom_point(data = biomassDataCleantEST,aes(x=TimePoint,y=LogDiff, color = Condition, shape = Strain ), size=4)+
  geom_smooth(data = biomassDataCleantEST,aes(x=TimePoint,y=LogDiff, color = Condition, linetype = Strain ), size=1)+
  labs(title ="title")+
  #scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme_cowplot()+
  theme(plot.title = element_text(hjust = 0.5))

ggplot()+#graph means
  geom_point(data = biomassDataCleantEST,aes(x=TimePoint,y=meanLogDiff, color = Condition, shape = Strain ), size=4)+
  #geom_smooth(data = biomassDataCleantEST,aes(x=TimePoint,y=LogDiff, color = Condition, linetype = Strain ), size=1)+
  #labs(title ="title")+
  labs(y = "ratio Pa / Sa")+
  #scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  theme_cowplot()+
  theme(plot.title = element_text(hjust = 0.5))

tenToOneData<-biomassDataCleantEST %>% filter(Condition %in% c("Pa:Sa 1:1","Pa:Sa 10:1")) %>% group_by(Species, Condition, Strain, TimePoint) %>% mutate(logMean = mean(LogTotals))
ggplot()+#graph means
  geom_point(data = tenToOneData,aes(x=TimePoint,y=logMean, color = Condition, shape = Strain ), size=4)+
  geom_line(data = tenToOneData,aes(x=TimePoint,y=logMean, color = Condition, linetype = Strain ), size=4)+
  #geom_smooth(data = biomassDataCleantEST,aes(x=TimePoint,y=LogDiff, color = Condition, linetype = Strain ), size=1)+
  #labs(title ="title")+
  labs(y = "ratio Pa / Sa")+
  #scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x), labels = scales::trans_format("log10", scales::math_format(10^.x)))+
  facet_grid(~Species)+
  theme_cowplot()+
  theme(plot.title = element_text(hjust = 0.5))
```

